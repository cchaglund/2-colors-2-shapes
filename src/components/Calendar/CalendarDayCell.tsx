import type { DailyChallenge, Shape } from '../../types';
import type { ViewMode, WinnerEntry } from './types';
import { SubmissionThumbnail } from '../shared/SubmissionThumbnail';
import { ChallengeShapeIndicators } from '../shared/ChallengeShapeIndicators';
import { Tooltip } from '../shared/InfoTooltip';
import { CalendarCell } from './CalendarCell';
import cn from "classnames";

/** Minimal submission shape needed by CalendarDayCell */
interface CalendarSubmission {
  shapes: Shape[];
  background_color_index: number | null;
}

interface CalendarDayCellProps {
  day: number;
  dateStr: string;
  viewMode: ViewMode;
  isToday: boolean;
  isFuture: boolean;
  challenge: DailyChallenge | undefined;
  submission: CalendarSubmission | undefined;
  ranking: number | undefined;
  dayWinners: WinnerEntry[] | undefined;
  latestWinnersDate: string;
  href?: string;
  onClick?: (day: number) => void;
  canView?: boolean;
  lockedContent?: React.ReactNode;
  hideEmptyDayIcon?: boolean;
}

export function CalendarDayCell({
  day,
  dateStr,
  viewMode,
  isToday,
  isFuture,
  challenge,
  submission,
  ranking,
  dayWinners,
  latestWinnersDate,
  href,
  onClick,
  canView = true,
  lockedContent,
  hideEmptyDayIcon,
}: CalendarDayCellProps) {
  const showWordTooltip = !isFuture && challenge?.word;

  if (viewMode === 'my-submissions') {
    // Locked day (profile privacy check)
    if (!canView && !isFuture) {
      return (
        <CalendarCell day={day} isToday={isToday} isFuture={false} data-testid="calendar-day-cell" data-date={dateStr}>
          {lockedContent}
        </CalendarCell>
      );
    }

    const isClickable = !isFuture && !!submission;
    const hasArt = !!submission && !!challenge;
    const hasRank = hasArt && ranking !== undefined && ranking >= 1 && ranking <= 3 ? (ranking as 1 | 2 | 3) : undefined;

    const cellContent = (
      <CalendarCell
        day={day}
        isToday={isToday}
        isFuture={isFuture}
        hasContent={hasArt}
        artFill={hasArt}
        rankOutline={hasRank}
        href={isClickable ? href : undefined}
        onClick={isClickable && !href && onClick ? () => onClick(day) : undefined}
        className="group"
        data-testid="calendar-day-cell"
        data-date={dateStr}
      >
        {hasArt && (
          <div className={cn(
            "absolute z-10 hidden group-hover:flex bg-black/70 rounded px-1 py-0.5",
            hasRank ? "-top-1 left-6" : "top-0.5 left-7"
          )}>
            <ChallengeShapeIndicators shapes={challenge.shapes} size={12} gap={4} color="white" />
          </div>
        )}
        {hasArt ? (
          <SubmissionThumbnail
            shapes={submission.shapes}
            challenge={challenge}
            backgroundColorIndex={submission.background_color_index}
            fill
          />
        ) : !isFuture && !hideEmptyDayIcon ? (
          <svg
            className="w-6 h-6 text-(--color-text-tertiary) opacity-40"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
            strokeWidth={2}
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              d="M6 18L18 6M6 6l12 12"
            />
          </svg>
        ) : null}
      </CalendarCell>
    );

    if (showWordTooltip) {
      return <Tooltip text={`"${challenge.word}"`} capitalize={true}>{cellContent}</Tooltip>;
    }
    return cellContent;
  }

  // Winners view
  const hasWinner = dayWinners && dayWinners.length > 0;
  const hasResults = dateStr <= latestWinnersDate;
  const hasWinnerArt = !!hasWinner && !!challenge;

  const cellContent = (
    <CalendarCell
      day={day}
      isToday={isToday}
      isFuture={isFuture}
      hasContent={hasWinnerArt}
      artFill={hasWinnerArt}
      href={hasWinner ? href : undefined}
      onClick={hasWinner && !href && onClick ? () => onClick(day) : undefined}
      data-testid="calendar-day-cell"
      data-date={dateStr}
    >
      {hasWinnerArt ? (
        <>
          <SubmissionThumbnail
            shapes={dayWinners[0].shapes}
            groups={dayWinners[0].groups}
            challenge={challenge}
            backgroundColorIndex={dayWinners[0].background_color_index}
            fill
          />
          {dayWinners.length > 1 && (
            <div className="absolute bottom-0.5 left-1/2 -translate-x-1/2 z-10 text-[10px] px-1 rounded bg-black/70 text-white">
              +{dayWinners.length - 1}
            </div>
          )}
        </>
      ) : !isFuture ? (
        hasResults ? (
          <div className="text-[11px] text-center text-(--color-text-tertiary)">
            No winners
          </div>
        ) : (
          <div className="text-[11px] text-center text-(--color-text-tertiary)">
            {isToday ? 'Creating...' : 'Voting...'}
          </div>
        )
      ) : null}
    </CalendarCell>
  );

  if (showWordTooltip) {
    return <Tooltip text={`"${challenge.word}"`} capitalize={true}>{cellContent}</Tooltip>;
  }
  return cellContent;
}
